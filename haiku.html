<html> 
  <head>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-53020648-4');
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jQuery-JSONP/2.4.0/jquery.jsonp.min.js'></script>
    <script src="http://www.youtube.com/player_api"></script>
    <script type='text/javascript'>
      const limit = 100
      let queue = []
      let position = 0
      let player
      let args = { subreddit: 'youtubehaiku', sort: 'new', time: 'month' }

      function shuffle (array) {
        for (var i = array.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1))
          var temp = array[i]
          array[i] = array[j]
          array[j] = temp
        }
      }

      function getIdFromUrl (url) {
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/
        var match = url.match(regExp)
        return (match && match[7].length === 11) ? match[7] : false
      }

      function getSubmissions () {
        const { subreddit, sort, time, after } = args
        let url
        if (!after) {
          url = `https://www.reddit.com/r/${subreddit}/${sort}/.json?limit=${limit}&t=${time}&jsonp=parseSubmissions`
          queue = []
        } else {
          url = `https://www.reddit.com/r/${subreddit}/${sort}/.json?limit=${limit}&t=${time}&after=${after}&jsonp=parseSubmissions`
        }
        $.jsonp({ url: url})
      }

      function parseSubmissions (res) {
        args.after = res.data.after
        const posts = res.data.children
        queue = queue.concat(posts.reduce((accu, post) => {
          const re = /^(https?\:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/
          if (post.data.url.match(re))
          accu.push({ 
            id: getIdFromUrl(post.data.url), 
            title: post.data.title, 
            url: post.data.permalink 
          })
          return accu
        }, []))
        shuffle(queue)
        updatePlayer()
      }

      function play () {
        delete args.after
        const input = $('form').serializeArray()
        input.forEach((input) => { 
          args[input.name] = input.value
        })
        args.subreddit = args.subreddit ? args.subreddit : 'videos'
        getSubmissions(args)
      }

      function updatePlayer () {
        const id = queue[position].id
        player.loadVideoById(id)
        $('#title').html(`<a href="https://www.reddit.com/${queue[position].url}"><h1>${queue[position].title}</h1></a>`)
      }

      function next () {
        if (position === queue.length - 2) getSubmissions()
        position++
        updatePlayer()
      }

      function prev () {
        if(!position) return
        position--
        updatePlayer()
      }

      function onYouTubePlayerAPIReady () {
        player = new YT.Player('player', {
          height: '100%',
          width: '100%',
          events: {
            'onStateChange': onPlayerStateChange
          }
        })
      }

      function onPlayerStateChange (e) {        
        if(e.data === 0) {            
          next()
        }
      }

      window.onload = play
      document.onkeydown = checkKey

      function checkKey (e) {
        e = e || window.event
        if (e.keyCode == '37') {
          prev()
        }
        else if (e.keyCode == '39') {
          next()
        }
      }
    </script>
  </head>
  <body id=player></body>
</html>
