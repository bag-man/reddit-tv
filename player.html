<html> 
  <head>
    <title>Whut-TV</title>
    <link rel='icon' type='image/png' href='https://raw.githubusercontent.com/bag-man/nodeup/master/public/assets/imgs/favicon.ico'/>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53020648-4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-53020648-4');
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jQuery-JSONP/2.4.0/jquery.jsonp.min.js'></script>
    <script src="http://www.youtube.com/player_api"></script>
    <script type='text/javascript'>
      const limit = 100
      let queue = []
      let position = 0
      let player
      let args = {}

      function getIdFromUrl(url){
        let regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/
        let match = url.match(regExp)
        return (match && match[7].length === 11) ? match[7] : false
      }

      function getSubmissions () {
        const { subreddit, sort, time, after } = args
        let url
        if (!after) {
          url = `https://www.reddit.com/r/${subreddit}/${sort}/.json?limit=${limit}&t=${time}&jsonp=parseSubmissions`
          queue = []
        } else {
          url = `https://www.reddit.com/r/${subreddit}/${sort}/.json?limit=${limit}&t=${time}&after=${after}&jsonp=parseSubmissions`
        }
        $.jsonp({ url: url});
      }

      function parseSubmissions (res) {
        args.after = res.data.after
        const posts = res.data.children
        queue = queue.concat(posts.reduce((accu, post) => {
          const re = /^(https?\:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/
          if (post.data.url.match(re))
          accu.push({ 
            id: getIdFromUrl(post.data.url), 
            title: post.data.title, 
            url: post.data.permalink 
          })
          return accu
        }, []))
        updatePlayer()
      }

      function play () {
        delete args.after
        const input = $('form').serializeArray()
        input.forEach((input) => { 
          args[input.name] = input.value
        })
        args.subreddit = args.subreddit ? args.subreddit : 'videos'
        getSubmissions(args)
      }

      function updatePlayer () {
        const id = queue[position].id
        player.loadVideoById(id)
        $('#title').html(`<a href="https://www.reddit.com/${queue[position].url}"><h1>${queue[position].title}</h1></a>`)
      }

      function next () {
        if (position === queue.length - 2) getSubmissions()
        position++
        updatePlayer()
      }

      function prev () {
        if(!position) return
        position--
        updatePlayer()
      }

      function onYouTubePlayerAPIReady() {
        player = new YT.Player('player', {
          height: '720',
          width: '1280',
          playerVars: {
            'autoplay': 1,
            'controls': 1, 
            'rel': 0,
          },
          events: {
            'onStateChange': onPlayerStateChange,
            'onError': next
          }
        })
      }

      function onPlayerStateChange(event) {        
        if(event.data === 0) {            
          next()
        }
      }

      window.onload = play

      document.onkeydown = checkKey

      function checkKey(e) {
        e = e || window.event
        if (e.keyCode == '37') {
          prev()
        } else if (e.keyCode == '39') {
          next()
        }
      }
    </script>
  </head>
  <body>
    <center>
      <div id=options>
        <form name=options action="javascript:play()"> 
          <input type=text name=subreddit placeholder=subreddit />
          <select name=sort>
            <option value="hot" selected>hot</option>
            <option value="new">new</option>
            <option value="top">top</option>
            <option value="rising">rising</option>
            <option value="controversial">controversial</option>
          </select>
          <select name=time>
            <option value="hour" >hour</option>
            <option value="day" selected>day</option>
            <option value="week">week</option>
            <option value="month">month</option>
            <option value="all">all</option>
          </select>
          <input name=submit type=submit value=play />
        </form>
      </div>
      <div id=controls style="padding-bottom: 25px">
        <button onclick="prev()">&lt;&lt; prev </button>
        <button onclick="next()">next &gt;&gt;</button>
      </div>
      <div id=player></div>
      <div id=title style="padding-top: 25px"></div>
    </center>
  </body>
</html>
